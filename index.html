<!DOCTYPE html>

<html lang="ja" prefix="og: http://ogp.me/ns#">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>ã‚¢ãƒ¡ãƒ€ã‚¹ãƒãƒƒãƒ— | å…¨å›½ã®ã‚¢ãƒ¡ãƒ€ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–</title>
  <meta name="version" content="2.0.0" />

  <!-- SEO Meta Tags -->
  <meta name="description" content="æ°—è±¡åºã®ã‚¢ãƒ¡ãƒ€ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã—ã¦ã€æ—¥æœ¬å…¨å›½ã®ç¾åœ¨ã®æ°—æ¸©ã€é™æ°´é‡ã€é¢¨é€Ÿã€ç©é›ªæ·±ã€æ¹¿åº¦ã‚’åœ°å›³ä¸Šã«å¯è¦–åŒ–ã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚">
  <meta name="keywords" content="ã‚¢ãƒ¡ãƒ€ã‚¹, å¤©æ°—, æ°—è±¡åº, æ°—æ¸©, é™æ°´é‡, é¢¨é€Ÿ, ç©é›ªæ·±, æ¹¿åº¦, å¯è¦–åŒ–, ãƒãƒƒãƒ—">
  <meta name="author" content="Genbu Hase">
  <meta name="robots" content="index, follow">

  <!-- Open Graph Protocol (OGP) -->
  <meta property="og:title" content="ã‚¢ãƒ¡ãƒ€ã‚¹ãƒãƒƒãƒ— | å…¨å›½ã®ã‚¢ãƒ¡ãƒ€ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://genbuhase.github.io/AMeDAS_Visualizer/">
  <!-- <meta property="og:image" content="https://genbuhase.github.io/ogp-image.png"> TODO: OGPç”»åƒã®URLã«å¤‰æ›´ -->
  <meta property="og:description" content="æ°—è±¡åºã®ã‚¢ãƒ¡ãƒ€ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã—ã¦ã€æ—¥æœ¬å…¨å›½ã®ç¾åœ¨ã®æ°—è±¡çŠ¶æ³ï¼ˆæ°—æ¸©ã€é™æ°´é‡ãªã©ï¼‰ã‚’åœ°å›³ä¸Šã«å¯è¦–åŒ–ã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚">
  <meta property="og:site_name" content="ã‚¢ãƒ¡ãƒ€ã‚¹ãƒãƒƒãƒ—">
  <meta property="og:locale" content="ja_JP">

  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ã‚¢ãƒ¡ãƒ€ã‚¹ãƒãƒƒãƒ—">
  <meta name="twitter:description" content="æ—¥æœ¬å…¨å›½ã®ã‚¢ãƒ¡ãƒ€ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆæ°—æ¸©ã€é™æ°´é‡ã€ç©é›ªæ·±ãªã©ï¼‰ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åœ°å›³ä¸Šã«è¡¨ç¤ºã—ã¾ã™ã€‚">
  <!-- <meta name="twitter:image" content="https://genbuhase.github.io/ogp-image.png"> TODO: OGPç”»åƒã®URLã«å¤‰æ›´ -->

  <!-- Icons (Placeholders) -->
  <!-- <link rel="icon" href="/favicon.ico"> TODO: faviconã®ç”»åƒã«å¤‰æ›´ -->
  <!-- <link rel="apple-touch-icon" href="/apple-touch-icon.png"> TODO: faviconã®ç”»åƒã«å¤‰æ›´ -->

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==" crossorigin="anonymous"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w==" crossorigin="anonymous">
  <!-- Tailwind CSS (for styling) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body,
    html {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: "Noto Sans JP", sans-serif;
      overflow: hidden; /* ã‚¹ãƒãƒ›ã§ã®ãƒã‚¦ãƒ³ã‚¹é˜²æ­¢ */
    }

    #map {
      height: 100%;
      width: 100%;
      z-index: 1;
    }

    /* ãƒ‘ãƒãƒ«ã®z-indexè¨­å®š */
    .info-panel {
      z-index: 1000;
    }

    .panel-header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(4px);
    }

    .panel-body {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(4px);
      /* é«˜ã•åˆ¶é™ã¯Tailwindã‚¯ãƒ©ã‚¹ã§è¡Œã†ãŸã‚å‰Šé™¤ */
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.8rem;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    /* ç©é›ªé‡ãƒ©ãƒ™ãƒ« (ãŠæ°—ã«å…¥ã‚Šç”¨) - ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    .fav-label {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }

    /* å¹ãå‡ºã—ã®çŸ¢å°ã‚’æ¶ˆã™ */
    .fav-label:before {
      display: none !important;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #bbb;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #999;
    }
  </style>
</head>

<body>
  <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <aside id="info-panel" class="absolute top-4 left-4 right-4 md:right-auto md:w-96 info-panel rounded-lg shadow-xl overflow-hidden transition-all duration-300 flex flex-col max-h-[calc(100dvh-2rem)]">
    <!-- ãƒ‘ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="panel-header p-4 flex justify-between items-center cursor-pointer border-b border-gray-100 hover:bg-gray-50 transition-colors flex-none" onclick="togglePanel()">
      <h1 class="text-xl font-bold text-gray-800 m-0">ğŸ—¾ ã‚¢ãƒ¡ãƒ€ã‚¹ãƒãƒƒãƒ—</h1>

      <button id="panel-toggle-icon" class="text-gray-500 hover:text-gray-700 font-bold transform transition-transform duration-300 p-1">
        â–¼
      </button>
    </header>

    <!-- ãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <article id="panel-body" class="panel-body p-4 pt-2 flex-1 overflow-y-auto overscroll-contain">
      <!-- ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– -->
      <div class="flex border-b border-gray-200">
        <div id="tab-all" onclick="event.stopPropagation(); switchMode(false)" class="flex-1 py-2 text-sm font-bold text-center cursor-pointer transition-colors border-b-2 border-blue-600 text-blue-600">ğŸ“Œ ã™ã¹ã¦ã®åœ°ç‚¹</div>
        <div id="tab-fav" onclick="event.stopPropagation(); switchMode(true)" class="flex-1 py-2 text-sm font-bold text-center cursor-pointer transition-colors border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50">â­ï¸ ãŠæ°—ã«å…¥ã‚Š</div>
      </div>

      <!-- è¦³æ¸¬æ—¥æ™‚ -->
      <div class="pt-4">
        <h2 class="text-sm font-bold text-gray-700 mb-2">ğŸ“… è¦³æ¸¬æ—¥æ™‚</h2>
        <p id="data-time" class="text-lg font-mono text-gray-900">----/--/-- --:--</p>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿ç¨®é¡é¸æŠ -->
      <div class="pt-4">
        <h2 class="text-sm font-bold text-gray-700 mb-2">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç¨®é¡</h2>
        <select id="dataTypeSelect" class="w-full p-2 border border-gray-300 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="changeDataType(this.value)">
          <option value="temp" selected>ğŸŒ¡ï¸ æ°—æ¸©</option>
          <option value="precipitation1h">â˜” é™æ°´é‡ï¼ˆ1æ™‚é–“ï¼‰</option>
          <option value="wind">ğŸƒ é¢¨é€Ÿ</option>
          <option value="snow">â›„ï¸ ç©é›ªæ·±</option>
          <option value="humidity">ğŸ’§ æ¹¿åº¦</option>
        </select>
      </div>

      <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°/ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆ -->
      <div id="ranking-container" class="pt-4 pb-4">
        <!-- JSã§å‹•çš„ã«æŒ¿å…¥ -->
      </div>

      <!-- å‡¡ä¾‹ -->
      <div class="border-t pt-4">
        <h2 class="text-sm font-bold text-gray-700 mb-2">å‡¡ä¾‹</h2>

        <div id="legend" class="grid grid-cols-2 gap-2">
          <!-- JSã§å‹•çš„ã«æŒ¿å…¥ -->
        </div>
      </div>

      <div class="border-t mt-4 pt-4 text-xs text-gray-500">
        ãƒ‡ãƒ¼ã‚¿å‡ºå…¸: <a href="https://www.jma.go.jp/" target="_blank" class="underline hover:text-blue-600">æ°—è±¡åº</a>
      </div>

      <button onclick="event.stopPropagation(); loadData()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200 shadow hover:shadow-md">
        ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      </button>
    </article>
  </aside>

  <!-- Map Container -->
  <main id="map"></main>

  <script>
    // --- è¨­å®š ---
    const PROXY_URL = 'https://corsproxy.io/?';
    const JMA_TILE_BASE = 'https://www.jma.go.jp/bosai/jmatile/data/snow';

    const MAP_CENTER = [38.0, 137.0];
    const MAP_ZOOM = 6;
    const STORAGE_KEY = 'amedas_favorites';

    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
    const DATA_TYPES = {
      temp: {
        name: 'æ°—æ¸©',
        unit: 'â„ƒ',
        icon: 'ğŸŒ¡ï¸',
        jmaElemCode: 'temp',
        colors: [
          { min: 35, color: '#960018', label: '35â„ƒ ï½' },
          { min: 30, color: '#ff2800', label: '30â„ƒ ï½' },
          { min: 25, color: '#ff9900', label: '25â„ƒ ï½' },
          { min: 20, color: '#f2f200', label: '20â„ƒ ï½' },
          { min: 15, color: '#00ff00', label: '15â„ƒ ï½' },
          { min: 10, color: '#00cfff', label: '10â„ƒ ï½' },
          { min: 5, color: '#0041ff', label: '5â„ƒ ï½' },
          { min: 0, color: '#218cff', label: '0â„ƒ ï½' },
          { min: -100, color: '#a0d2ff', label: '0â„ƒ æœªæº€' }
        ],
        sortDesc: true
      },

      precipitation1h: {
        name: 'é™æ°´é‡ï¼ˆ1æ™‚é–“ï¼‰',
        unit: 'mm',
        icon: 'ğŸŒ§ï¸',
        jmaElemCode: 'precipitation1h',
        colors: [
          { min: 80, color: '#b40068', label: '80mm ï½' },
          { min: 50, color: '#ff2800', label: '50mm ï½' },
          { min: 30, color: '#ff9900', label: '30mm ï½' },
          { min: 20, color: '#f2f200', label: '20mm ï½' },
          { min: 10, color: '#218cff', label: '10mm ï½' },
          { min: 5, color: '#0041ff', label: '5mm ï½' },
          { min: 1, color: '#a0d2ff', label: '1mm ï½' },
          { min: 0, color: '#cccccc', label: '0mm' }
        ],
        sortDesc: true
      },

      wind: {
        name: 'é¢¨é€Ÿ',
        unit: 'm/s',
        icon: 'ğŸ’¨',
        jmaElemCode: 'wind',
        colors: [
          { min: 25, color: '#ff0000', label: '25m/s ï½' },
          { min: 20, color: '#ff5500', label: '20m/s ï½' },
          { min: 15, color: '#ff9900', label: '15m/s ï½' },
          { min: 10, color: '#f2f200', label: '10m/s ï½' },
          { min: 5, color: '#00cf00', label: '5m/s ï½' },
          { min: 3, color: '#00ff7f', label: '3m/s ï½' },
          { min: 0, color: '#cccccc', label: '0m/s ï½' }
        ],
        sortDesc: true
      },

      snow: {
        name: 'ç©é›ªæ·±',
        unit: 'cm',
        icon: 'â›„',
        jmaElemCode: 'snow',
        colors: [
          { min: 200, color: '#e600ab', label: '200cm ï½' },
          { min: 150, color: '#ff2800', label: '150cm ï½' },
          { min: 100, color: '#ff9900', label: '100cm ï½' },
          { min: 50, color: '#f2f200', label: '50cm ï½' },
          { min: 20, color: '#0041ff', label: '20cm ï½' },
          { min: 5, color: '#218cff', label: '5cm ï½' },
          { min: 1, color: '#a0d2ff', label: '1cm ï½' },
          { min: 0, color: '#cccccc', label: '0cm' }
        ],
        sortDesc: true
      },

      humidity: {
        name: 'æ¹¿åº¦',
        unit: '%',
        icon: 'ğŸ’§',
        jmaElemCode: 'humidity',
        colors: [
          { min: 90, color: '#0041ff', label: '90% ï½' },
          { min: 70, color: '#00cfff', label: '70% ï½' },
          { min: 50, color: '#00ff00', label: '50% ï½' },
          { min: 30, color: '#f2f200', label: '30% ï½' },
          { min: 0, color: '#ff9900', label: '0% ï½' }
        ],
        sortDesc: true
      }
    };

    // --- ãƒãƒƒãƒ—åˆæœŸåŒ– ---
    const map = L.map('map', { zoomControl: false }).setView(MAP_CENTER, MAP_ZOOM);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // åœ°ç†é™¢åœ°å›³ (æ·¡è‰²åœ°å›³)
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>",
      maxZoom: 18,
      minZoom: 5
    }).addTo(map);

    let geoJsonLayer = null;
    let currentGeoData = null; // å–å¾—ã—ãŸã‚¢ãƒ¡ãƒ€ã‚¹ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯GeoJSONãƒ‡ãƒ¼ã‚¿(ç©é›ªæ·±)
    let isFavoriteMode = false; // ãŠæ°—ã«å…¥ã‚Šè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
    let currentPopupCode = null; // å†æç”»æ™‚ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒã™ã‚‹ãŸã‚ã®å¤‰æ•°
    let currentDataType = 'temp'; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ç¨®é¡
    let amedasStations = null; // è¦³æ¸¬æ‰€ãƒ‡ãƒ¼ã‚¿(amedastable.json)

    // --- å‡¡ä¾‹ã®ç”Ÿæˆ ---
    const legendContainer = document.getElementById('legend');
    
    function updateLegend() {
      legendContainer.innerHTML = '';
      const typeConfig = DATA_TYPES[currentDataType];
      if (!typeConfig) return;

      typeConfig.colors.forEach(item => {
        const div = document.createElement('div');
        div.className = 'legend-item';
        // 0ã®æ™‚ãªã©ç‰¹å®šæ¡ä»¶ã§æ ç·šã‚’ã¤ã‘ã‚‹
        const borderStyle = (item.min === 0 || item.label.includes('0mm')) ? 'border: 1px solid #999;' : '';
        div.innerHTML = `<div class="legend-color" style="background:${item.color}; ${borderStyle}"></div><span>${item.label}</span>`;
        legendContainer.appendChild(div);
      });
    }

    // åˆæœŸè¡¨ç¤º
    updateLegend();

    // --- ãƒ‡ãƒ¼ã‚¿ç¨®é¡å¤‰æ›´ ---
    function changeDataType(type) {
      if (currentDataType === type) return;
      currentDataType = type;
      updateLegend();
      loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ãƒ»å†æç”»
    }

    // --- UI ãƒ‘ãƒãƒ«åˆ¶å¾¡ ---
    function togglePanel() {
      const body = document.getElementById('panel-body');
      const icon = document.getElementById('panel-toggle-icon');
      const panel = document.getElementById('info-panel');

      if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.style.transform = 'rotate(0deg)'; // å…ƒã«æˆ»ã™
        panel.style.height = 'auto'; 
      } else {
        body.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)'; // æ¨ªå‘ãã«ã™ã‚‹
        panel.style.height = 'auto';
      }
    }

    // --- LocalStorage / ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ ---
    function getFavorites() {
      try {
        // æ–‡å­—åˆ—å‹ã¨ã—ã¦å–å¾—ãƒ»ä¿å­˜ã‚’çµ±ä¸€ã™ã‚‹
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]').map(String);
      } catch {
        return [];
      }
    }

    function isFavorite(code) {
      return getFavorites().includes(String(code));
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹ (ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰å‘¼ã¶ãŸã‚)
    window.toggleFavorite = function (code) {
      const strCode = String(code); // å‹ã‚’æ–‡å­—åˆ—ã«çµ±ä¸€
      let favs = getFavorites();

      let isFavNow = false;

      if (favs.includes(strCode)) {
        favs = favs.filter(c => c !== strCode);
        isFavNow = false;
      } else {
        favs.push(strCode);
        isFavNow = true;
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(favs));

      // å†æç”»ã‚’è¡Œã† (ã‚¹ã‚¿ã‚¤ãƒ«ã®å³æ™‚åæ˜ ã®ãŸã‚)
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã¦ã—ã¾ã‚ãªã„ã‚ˆã†ã€currentPopupCode ã‚’ã‚»ãƒƒãƒˆã—ã¦ renderMap ã§å¾©å…ƒã™ã‚‹
      currentPopupCode = strCode;
      renderMap();
    };

    // --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ---
    window.switchMode = function (toFavoriteMode) {
      isFavoriteMode = toFavoriteMode;

      const tabAll = document.getElementById('tab-all');
      const tabFav = document.getElementById('tab-fav');

      const activeClass = "flex-1 py-2 text-sm font-bold text-center cursor-pointer transition-colors border-b-2 border-blue-600 text-blue-600";
      const inactiveClass = "flex-1 py-2 text-sm font-bold text-center cursor-pointer transition-colors border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50";

      if (isFavoriteMode) {
        tabAll.className = inactiveClass;
        tabFav.className = activeClass;
      } else {
        tabAll.className = activeClass;
        tabFav.className = inactiveClass;
      }

      renderMap();
    };

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---

    // å€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatValue(val) {
      if (val === null || val === undefined) return '-';
      return val.toLocaleString();
    }

    // è¦³æ¸¬æ‰€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã®å€¤ã‚’å–å¾—
    function getValue(props) {
      if (!props) return null;
      
      let val = null;

      // ç©é›ªæ·±ãƒ¢ãƒ¼ãƒ‰ (GeoJSONç”±æ¥ã¾ãŸã¯JSONç”±æ¥)
      if (currentDataType === 'snow') {
        // GeoJSON (jmatile) ç”±æ¥ã®å ´åˆ
        if (props.snowd !== undefined) val = props.snowd;
        // JSON (amedas/map) ç”±æ¥ã®å ´åˆ
        else if (props.snow !== undefined) val = props.snow;
        else if (props.val !== undefined) val = props.val;
      } else {
        // ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ‰ (JSONç”±æ¥)
        val = props[currentDataType];
      }
      
      // å€¤ãŒãªã„å ´åˆ (undefined, null)
      if (val === undefined || val === null) return null;
      
      // é…åˆ—ã®å ´åˆ(JSONç”±æ¥ã®ä¸€éƒ¨)ã¯[å€¤, ãƒ•ãƒ©ã‚°]
      if (Array.isArray(val)) {
         val = val[0];
      }

      const num = parseFloat(val);
      return isNaN(num) ? null : num;
    }

    // è‰²ã‚’å–å¾—
    function getColor(val) {
      const typeConfig = DATA_TYPES[currentDataType];
      if (val === null || val === undefined) return '#ccc';
      
      // colors é…åˆ—ã‚’ä¸Šã‹ã‚‰è¦‹ã¦æ¡ä»¶ã«åˆã†ã‚‚ã®ã‚’è¿”ã™
      const config = typeConfig.colors.find(c => val >= c.min);
      return config ? config.color : '#ccc';
    }

    // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸåŠå¾„è¨ˆç®—
    function calcRadius(zoom, val) {
      if (val === null || val === undefined) val = 0;
      
      // 0å€¤åœ°ç‚¹ã¯è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚æœ€å°åŠå¾„ã‚’ç¢ºä¿
      if (val <= 0) return zoom < 7 ? 3 : 5;

      // åŸºç¤ã‚µã‚¤ã‚º: ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„ã»ã©å¤§ãã
      let baseSize = (zoom - 4) * 1.2;
      if (baseSize < 2) baseSize = 2;

      // å€¤ã«ã‚ˆã‚‹è£œæ­£ (ç©é›ªæ·±ä»¥å¤–ã§ã‚‚å¤§ããã—ã™ããªã„ã‚ˆã†ã«èª¿æ•´)
      let factor = 0;
      if (val > 0) {
          factor = Math.sqrt(val) * 0.5;
          // ç©é›ªæ·±ãªã©ã§å€¤ãŒå¤§ãã„å ´åˆã®ã‚­ãƒ£ãƒƒãƒ—çš„ãªèª¿æ•´
          if (currentDataType === 'snow' && val > 200) {
             factor += (val - 200) * 0.05;
          }
      }

      return baseSize + factor;
    }

    // UTCæ–‡å­—åˆ—(YYYYMMDDHHmm)ã‚’JSTæ–‡å­—åˆ—(YYYY/MM/DD HH:mm)ã«å¤‰æ›
    function formatUtcToJst(dateStr) {
      if (!dateStr || dateStr.length < 12) return "--/-- --:--";
      const year = parseInt(dateStr.substring(0, 4), 10);
      const month = parseInt(dateStr.substring(4, 6), 10) - 1;
      const day = parseInt(dateStr.substring(6, 8), 10);
      const hour = parseInt(dateStr.substring(8, 10), 10);
      const min = parseInt(dateStr.substring(10, 12), 10);

      const utcDate = new Date(Date.UTC(year, month, day, hour, min));

      const JST_OFFSET = 9 * 60 * 60 * 1000;
      const jstDate = new Date(utcDate.getTime() + JST_OFFSET);

      const y = jstDate.getUTCFullYear();
      const m = String(jstDate.getUTCMonth() + 1).padStart(2, '0');
      const d = String(jstDate.getUTCDate()).padStart(2, '0');
      const h = String(jstDate.getUTCHours()).padStart(2, '0');
      const mi = String(jstDate.getUTCMinutes()).padStart(2, '0');

      return `${y}/${m}/${d} ${h}:${mi}`;
    }

    // --- ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ ---

    async function fetchWithProxy(url) {
      try {
        const targetUrl = PROXY_URL + encodeURIComponent(url);
        const response = await fetch(targetUrl);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
      } catch (e) {
        console.error("Fetch failed (Proxy):", e);
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (e2) {
          throw new Error(`ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        }
      }
    }

    // ã‚¢ãƒ¡ãƒ€ã‚¹è¦³æ¸¬æ‰€ä¸€è¦§ã®å–å¾—
    async function fetchStations() {
      if (amedasStations) return amedasStations;
      const url = 'https://www.jma.go.jp/bosai/amedas/const/amedastable.json';
      try {
        amedasStations = await fetchWithProxy(url);
        return amedasStations;
      } catch (e) {
        console.error("Failed to fetch station list:", e);
        throw e;
      }
    }

    // æœ€æ–°æ™‚åˆ»ã®å–å¾— (ãã®ä»–ã®ãƒ‡ãƒ¼ã‚¿ç”¨)
    async function getLatestAmedasTime() {
      const url = 'https://www.jma.go.jp/bosai/amedas/data/latest_time.txt';
      try {
        // ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (ä¾‹: 2024-01-01T12:00:00+09:00)
        const response = await fetch(PROXY_URL + encodeURIComponent(url));
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const text = await response.text();
        return new Date(text.trim()); // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
      } catch (e) {
        console.error("æœ€æ–°æ™‚åˆ»å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
        throw e;
      }
    }
    
    // å…¨å›½ãƒ‡ãƒ¼ã‚¿ã®å–å¾— (JSONå½¢å¼)
    async function fetchAmedasMapData(dateObj) {
      // YYYYMMDDHHmmsså½¢å¼ã«å¤‰æ›
      const pad = (n) => n.toString().padStart(2, '0');
      const yyyy = dateObj.getFullYear();
      const mm = pad(dateObj.getMonth() + 1);
      const dd = pad(dateObj.getDate());
      const hh = pad(dateObj.getHours());
      const mi = pad(Math.floor(dateObj.getMinutes() / 10) * 10); // 10åˆ†å˜ä½ã«ä¸¸ã‚ã‚‹
      const ss = '00';
      
      const timeStr = `${yyyy}${mm}${dd}${hh}${mi}${ss}`;
      const url = `https://www.jma.go.jp/bosai/amedas/data/map/${timeStr}.json`;
      
      return await fetchWithProxy(url);
    }

    async function getLatestSnowTimeData() {
      const url = `${JMA_TILE_BASE}/targetTimes.json`;
      try {
        const data = await fetchWithProxy(url);
        if (!Array.isArray(data)) throw new Error("targetTimes is not an array");

        const latestValid = data.find(item =>
          item.elements && item.elements.includes("amds_snowd")
        );

        if (latestValid) return latestValid;
        throw new Error("Valid snow data (amds_snowd) not found in targetTimes");
      } catch (e) {
        console.error(e);
        throw new Error("æœ€æ–°æ™‚åˆ»æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }

    map.on('zoomend', function () {
      if (!geoJsonLayer) return;
      const currentZoom = map.getZoom();

      geoJsonLayer.eachLayer(function (layer) {
        if (layer.feature && layer.feature.properties) {
          const val = getValue(layer.feature.properties);
          layer.setRadius(calcRadius(currentZoom, val));
        }
      });
    });

    // ãƒãƒƒãƒ—æç”»é–¢æ•°
    function renderMap() {
      if (!currentGeoData) return;

      if (geoJsonLayer) {
        map.removeLayer(geoJsonLayer);
      }

      const favs = getFavorites();

      geoJsonLayer = L.geoJSON(currentGeoData, {
        filter: function (feature) {
          const props = feature.properties || {};
          const val = getValue(props);

          // å€¤ãŒãªã„ã€ã¾ãŸã¯ç„¡åŠ¹ãªå€¤ã®å ´åˆã¯è¡¨ç¤ºã—ãªã„
          if (val === null || val === undefined) return false;
          
          // ç©é›ªæ·±ã®å ´åˆã®æ¬ æ¸¬å€¤é™¤å¤– (æ—¢å­˜äº’æ›)
          if (currentDataType === 'snow' && val === 32767) return false;

          if (isFavoriteMode) {
            return favs.includes(String(props.code));
          }

          return true;
        },

        pointToLayer: function (feature, latlng) {
          const props = feature.properties || {};
          const val = getValue(props);

          let color = getColor(val);
          let opacity = 0.8;
          let borderColor = '#fff';
          let weight = 1;
          let radius = calcRadius(map.getZoom(), val);

          if (!val) {
            color = '#cccccc'; // ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´
            borderColor = '#666'; // å°‘ã—æ¿ƒã„æ ç·š
            opacity = 1.0;
          }

          // ãŠæ°—ã«å…¥ã‚Šå¼·èª¿
          const isFav = isFavorite(props.code);
          if (isFav) {
            borderColor = '#ff0000'; // èµ¤æ 
            weight = 2;              // å¤ªæ 
            opacity = 1.0;
          }

          const marker = L.circleMarker(latlng, {
            radius: radius,
            fillColor: color,
            color: borderColor,
            weight: weight,
            opacity: opacity,
            fillOpacity: opacity
          });

          // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è¨­å®š
          let unit = DATA_TYPES[currentDataType].unit;
          let label = DATA_TYPES[currentDataType].name;
          let elemCode = DATA_TYPES[currentDataType].jmaElemCode || 'snow';

          // åœ°ç‚¹åè§£æ±º
          const nameJP = props.nameJP || props.kjName || props.name || "åœ°ç‚¹";
          const nameKana = props.nameKana || props.knName || "";
          let displayName = nameJP;
          let subName = nameKana;
          
          if (!displayName || displayName === "åœ°ç‚¹") {
             displayName = props.code || "åœ°ç‚¹";
             subName = "";
          }

          let graphLinkHtml = "";
          let favBtnHtml = "";
          const code = props.code;

          if (code) {
             const jmaGraphUrl = `https://www.jma.go.jp/bosai/amedas/#amdno=${code}&format=graph&elem=${elemCode}`;
             
             graphLinkHtml = `
              <a
                href="${jmaGraphUrl}" target="_blank" rel="noopener noreferrer" 
                class="flex-1 bg-white hover:bg-blue-50 text-blue-600 border border-blue-600 text-sm font-bold py-2 px-3 rounded text-center transition no-underline flex items-center justify-center" style="color: #2563eb !important; text-decoration: none !important;">
                ğŸ“Š æ¨ç§»ã‚°ãƒ©ãƒ•
              </a>
            `;
            
            const btnText = isFav ? 'â˜… è§£é™¤' : 'â˜† ãŠæ°—ã«å…¥ã‚Š';
            const btnClass = isFav
              ? "flex-1 bg-yellow-50 text-yellow-700 border border-yellow-300 text-sm font-bold py-2 px-3 rounded cursor-pointer hover:bg-yellow-100 transition flex items-center justify-center"
              : "flex-1 bg-white text-gray-600 border border-gray-300 text-sm font-bold py-2 px-3 rounded cursor-pointer hover:bg-gray-50 transition flex items-center justify-center";

            favBtnHtml = `
              <button onclick="toggleFavorite('${code}')" class="${btnClass}">
                  ${btnText}
              </button>
            `;
            
            // ãŠæ°—ã«å…¥ã‚Šåœ°ç‚¹ã®å ´åˆã®Tooltip (å¼·èª¿è¡¨ç¤º)
             if (isFav && val !== null) {
              const tooltipHtml = `
                <div style="background-color: ${color}; color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px; text-shadow: 0 0 2px #000;">
                  ${formatValue(val)}${unit}
                </div>
              `;
              marker.bindTooltip(tooltipHtml, { permanent: true, direction: 'right', offset: [8, 0], className: 'fav-label', opacity: 1 });
            }
          }

          let popupContent = `
            <div class="font-sans min-w-[240px]">
                <div class="font-bold text-lg mb-1">${displayName}</div>
                ${subName ? `<div class="text-xs text-gray-600 mb-1">${subName}</div>` : ''}
                <hr class="my-2 border-gray-300">
                <div class="mb-3">
                    <span class="text-sm text-gray-600">${label}:</span>
                    <span class="font-bold text-2xl ml-1" style="color:${color}">${formatValue(val)}</span>
                    <span class="text-sm ml-1">${unit}</span>
                </div>
                <div class="flex gap-2">
                    ${graphLinkHtml}
                    ${favBtnHtml}
                </div>
            </div>
          `;

          marker.bindPopup(popupContent, { minWidth: 240 });

          // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¾©å…ƒ
          if (currentPopupCode && String(props.code) === String(currentPopupCode)) {
             setTimeout(() => marker.openPopup(), 100);
             currentPopupCode = null; 
          }

          return marker;
        }
      }).addTo(map);
      
      updateRankingList();
    }

    // --- ãƒªã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ ---
    function updateRankingList() {
      const container = document.getElementById('ranking-container');
      container.innerHTML = '';

      if (!currentGeoData || !currentGeoData.features) return;

      const typeConfig = DATA_TYPES[currentDataType];
      
      // ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã¨æ•´å½¢
      let items = currentGeoData.features.map(f => {
        const props = f.properties;
        const val = getValue(props);

        // åœ°ç‚¹åè§£æ±º
        const nameJP = props.nameJP || props.kjName || props.name || "åœ°ç‚¹";
        const code = String(props.code);
        
        return {
          code: code,
          name: nameJP,
          val: val,
          lat: f.geometry.coordinates[1], // GeoJSONã¯ [lon, lat]
          lon: f.geometry.coordinates[0]
        };
      }).filter(item => {
          const val = item.val;
          if (val === null || val === undefined) return false;
          if (currentDataType === 'snow' && val === 32767) return false;
          return true;
      });

      // ä¸¦ã³æ›¿ãˆ (é™é †/æ˜‡é †)
      items.sort((a, b) => {
        if (typeConfig.sortDesc) return b.val - a.val;
        return a.val - b.val;
      });

      // è¡¨ç¤ºã‚¢ã‚¤ãƒ†ãƒ ã®é¸å®š
      let displayItems = [];
      let title = "";

      if (isFavoriteMode) {
        const favs = getFavorites();
        displayItems = items.filter(item => favs.includes(item.code));
        title = `â­ï¸ ãŠæ°—ã«å…¥ã‚Šåœ°ç‚¹`;
        
        if (displayItems.length === 0) {
           container.innerHTML = `<h3 class="text-sm font-bold text-gray-700 mb-2">${title}</h3><div class="text-sm text-gray-500 text-center py-2 bg-gray-50 rounded">ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
           return;
        }
      } else {
        displayItems = items.slice(0, 10); // Top 10
        title = `ğŸ†ï¸ ${typeConfig.name}ãƒ©ãƒ³ã‚­ãƒ³ã‚°`;
      }
      
      // HTMLç”Ÿæˆ
      let html = `<h3 class="text-sm font-bold text-gray-700 mb-2">${title}</h3><ul class="text-sm space-y-1 max-h-60 overflow-y-auto pr-1">`;
      
      displayItems.forEach((item, index) => {
        const rankStr = isFavoriteMode ? '' : `<span class="inline-block w-5 text-center font-bold text-gray-500 mr-1">${index + 1}.</span>`;
        const color = getColor(item.val);
        
        html += `
          <li class="flex justify-between items-center p-2 hover:bg-gray-100 rounded cursor-pointer transition-colors" onclick="flyToPoint(${item.lat}, ${item.lon}, '${item.code}')">
              <div class="truncate flex-1 flex items-center">
                  ${rankStr}
                  <span class="font-medium text-gray-800 truncate">${item.name}</span>
              </div>
              <div class="font-bold whitespace-nowrap ml-2" style="color:${color}">
                  ${formatValue(item.val)} <span class="text-xs text-black">${typeConfig.unit}</span>
              </div>
          </li>
        `;
      });
      
      html += '</ul>';
      container.innerHTML = html;
    }

    // åœ°ç‚¹ã¸ç§»å‹•ã—ã¦ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
    window.flyToPoint = function (lat, lon, code) {
      map.flyTo([lat, lon], 12, { duration: 1.5 });
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ããŸã‚ã«å°‘ã—å¾…ã¤ (ç§»å‹•å®Œäº†å¾Œ)
      setTimeout(() => {
        if (geoJsonLayer) {
          geoJsonLayer.eachLayer(layer => {
            const props = layer.feature.properties || {};
            if (String(props.code) === String(code)) {
              layer.openPopup();
            }
          });
        }
      }, 1600);
    };

    window.loadData = async function () {
      // è¦³æ¸¬æ‰€ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°å–å¾—
      try {
        await fetchStations();
      } catch (e) {
        alert("è¦³æ¸¬æ‰€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        return;
      }

      // èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º
      document.getElementById('data-time').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
      const container = document.getElementById('ranking-container');
      container.innerHTML = '<div class="text-center text-gray-500 py-4">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      try {
        if (currentDataType === 'snow') {
          // ç©é›ªæ·±: æ—¢å­˜ã®GeoJSON APIã‚’ä½¿ç”¨
          const targetTime = await getLatestSnowTimeData();
          const validTime = targetTime.validtime; // GMT
          const baseTime = targetTime.basetime;
          
          const geoJsonUrl = `${JMA_TILE_BASE}/${baseTime}/none/${validTime}/surf/amds_snowd/data.geojson`;
          currentGeoData = await fetchWithProxy(geoJsonUrl);
          
          // æ™‚åˆ»è¡¨ç¤º (GMT -> JST)
          const jstDate = formatUtcToJst(validTime);
          document.getElementById('data-time').textContent = jstDate;
          
        } else {
          // ãã®ä»–: æ–°ã‚¢ãƒ¡ãƒ€ã‚¹API (JSON) ã‚’ä½¿ç”¨
          const latestTime = await getLatestAmedasTime();
          
          // æ™‚åˆ»è¡¨ç¤º
          // YYYY/MM/DD HH:mm å½¢å¼
          const pad = n => n.toString().padStart(2, '0');
          const timeStr = `${latestTime.getFullYear()}/${pad(latestTime.getMonth()+1)}/${pad(latestTime.getDate())} ${pad(latestTime.getHours())}:${pad(latestTime.getMinutes())}`;
          document.getElementById('data-time').textContent = timeStr;
          
          // ãƒ‡ãƒ¼ã‚¿å–å¾—
          const mapData = await fetchAmedasMapData(latestTime);
          
          // GeoJSONã¸ã®å¤‰æ› (amedasStationsã¨ãƒãƒ¼ã‚¸)
          const features = [];
          
          Object.keys(mapData).forEach(code => {
            const station = amedasStations[code];
            const data = mapData[code];
            
            if (station && data) {
              const lat = station.lat[0] + station.lat[1] / 60;
              const lon = station.lon[0] + station.lon[1] / 60;
              
              const props = {
                code: code,
                kjName: station.kjName,
                knName: station.knName,
                // å„ãƒ‡ãƒ¼ã‚¿
                temp: data.temp ? data.temp[0] : undefined,
                precipitation1h: data.precipitation1h ? data.precipitation1h[0] : undefined,
                wind: data.wind ? data.wind[0] : undefined,
                windDirection: data.windDirection ? data.windDirection[0] : undefined,
                humidity: data.humidity ? data.humidity[0] : undefined,
                snow: data.snow ? data.snow[0] : undefined
              };
              
              features.push({
                type: "Feature",
                geometry: {
                  type: "Point",
                  coordinates: [lon, lat]
                },
                properties: props
              });
            }
          });
          
          currentGeoData = {
            type: "FeatureCollection",
            features: features
          };
        }
        
        renderMap();
        
      } catch (e) {
        console.error(e);
        alert("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
        document.getElementById('data-time').textContent = '----/--/-- --:--';
        container.innerHTML = '';
      }
    }

    window.onload = loadData;
  </script>
</body>

</html>