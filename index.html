<!DOCTYPE html>

<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>ã‚¢ãƒ¡ãƒ€ã‚¹ç©é›ªãƒãƒƒãƒ—</title>
  <meta name="version" content="1.0.0" />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==" crossorigin="anonymous"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w==" crossorigin="anonymous">
  <!-- Tailwind CSS (for styling) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body,
    html {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: "Noto Sans JP", sans-serif;
      overflow: hidden; /* ã‚¹ãƒãƒ›ã§ã®ãƒã‚¦ãƒ³ã‚¹é˜²æ­¢ */
    }

    #map {
      height: 100%;
      width: 100%;
      z-index: 1;
    }

    /* ãƒ‘ãƒãƒ«ã®z-indexè¨­å®š */
    .info-panel {
      z-index: 1000;
    }

    .panel-header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(4px);
    }

    .panel-body {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(4px);
      /* é«˜ã•åˆ¶é™ã¯Tailwindã‚¯ãƒ©ã‚¹ã§è¡Œã†ãŸã‚å‰Šé™¤ */
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.8rem;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    /* ç©é›ªé‡ãƒ©ãƒ™ãƒ« (ãŠæ°—ã«å…¥ã‚Šç”¨) - ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    .fav-label {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }

    /* å¹ãå‡ºã—ã®çŸ¢å°ã‚’æ¶ˆã™ */
    .fav-label:before {
      display: none !important;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #bbb;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #999;
    }
  </style>
</head>

<body>
  <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <aside id="info-panel" class="absolute top-4 left-4 right-4 md:right-auto md:w-96 info-panel rounded-lg shadow-xl overflow-hidden transition-all duration-300 flex flex-col max-h-[calc(100dvh-2rem)]">
    <!-- ãƒ‘ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="panel-header p-4 flex justify-between items-center cursor-pointer border-b border-gray-100 hover:bg-gray-50 transition-colors flex-none" onclick="togglePanel()">
      <h1 class="text-xl font-bold text-gray-800 m-0">â›„ ã‚¢ãƒ¡ãƒ€ã‚¹ç©é›ªãƒãƒƒãƒ—</h1>

      <button id="panel-toggle-icon" class="text-gray-500 hover:text-gray-700 font-bold transform transition-transform duration-300 p-1">
        â–¼
      </button>
    </header>

    <!-- ãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <article id="panel-body" class="panel-body p-4 pt-2 flex-1 overflow-y-auto overscroll-contain">
      <!-- ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– -->
      <div class="flex border-b border-gray-200">
        <div id="tab-all" onclick="event.stopPropagation(); switchMode(false)" class="flex-1 py-2 text-sm font-bold text-center cursor-pointer transition-colors border-b-2 border-blue-600 text-blue-600">ğŸ“Œ ã™ã¹ã¦ã®åœ°ç‚¹</div>
        <div id="tab-fav" onclick="event.stopPropagation(); switchMode(true)" class="flex-1 py-2 text-sm font-bold text-center cursor-pointer transition-colors border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50">â­ï¸ ãŠæ°—ã«å…¥ã‚Š</div>
      </div>

      <!-- è¦³æ¸¬æ—¥æ™‚ -->
      <div class="pt-4">
        <h2 class="text-sm font-bold text-gray-700 mb-2">ğŸ“… è¦³æ¸¬æ—¥æ™‚</h2>
        <p id="data-time" class="text-lg font-mono text-gray-900">----/--/-- --:--</p>
      </div>

      <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°/ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆ -->
      <div id="ranking-container" class="pt-4 pb-4">
        <!-- JSã§å‹•çš„ã«æŒ¿å…¥ -->
      </div>

      <!-- å‡¡ä¾‹ -->
      <div class="border-t pt-4">
        <h2 class="text-sm font-bold text-gray-700 mb-2">å‡¡ä¾‹</h2>

        <div id="legend" class="grid grid-cols-2 gap-2">
          <!-- JSã§å‹•çš„ã«æŒ¿å…¥ -->
        </div>
      </div>

      <div class="border-t mt-4 pt-4 text-xs text-gray-500">
        ãƒ‡ãƒ¼ã‚¿å‡ºå…¸: <a href="https://www.jma.go.jp/" target="_blank" class="underline hover:text-blue-600">æ°—è±¡åº</a><br>
        â€»ç©é›ªè¨ˆã®ã‚ã‚‹ã‚¢ãƒ¡ãƒ€ã‚¹è¦³æ¸¬æ‰€ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
        â€»CORSåˆ¶é™å›é¿ã®ãŸã‚ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
      </div>

      <button onclick="event.stopPropagation(); loadData()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200 shadow hover:shadow-md">
        ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      </button>
    </article>
  </aside>

  <!-- Map Container -->
  <main id="map"></main>

  <script>
    // --- è¨­å®š ---
    const PROXY_URL = 'https://corsproxy.io/?';
    const JMA_TILE_BASE = 'https://www.jma.go.jp/bosai/jmatile/data/snow';

    const MAP_CENTER = [38.0, 137.0];
    const MAP_ZOOM = 6;
    const STORAGE_KEY = 'amedas_favorites';

    // --- è‰²è¨­å®š (ç©é›ªæ·± cm) ---
    const SNOW_COLORS = [
      { min: 200, color: '#e600ab', label: '200cm ï½' }, // çŒ›çƒˆãªé›ª
      { min: 150, color: '#ff2800', label: '150cm ï½' }, // éå¸¸ã«å¤šã„
      { min: 100, color: '#ff9900', label: '100cm ï½' }, // ã‹ãªã‚Šå¤šã„
      { min: 50, color: '#f2f200', label: '50cm ï½' },   // å¤šã„
      { min: 20, color: '#0041ff', label: '20cm ï½' },   // ã‚„ã‚„å¤šã„
      { min: 5, color: '#218cff', label: '5cm ï½' },     // å°‘ãªã‚
      { min: 1, color: '#a0d2ff', label: '1cm ï½' },     // ç©é›ªã‚ã‚Š
      { min: 0, color: '#cccccc', label: '0cm' }        // ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´ (#cccccc)
    ];

    // --- ãƒãƒƒãƒ—åˆæœŸåŒ– ---
    const map = L.map('map', { zoomControl: false }).setView(MAP_CENTER, MAP_ZOOM);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // åœ°ç†é™¢åœ°å›³ (æ·¡è‰²åœ°å›³)
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>",
      maxZoom: 18,
      minZoom: 5
    }).addTo(map);

    let geoJsonLayer = null;
    let currentGeoData = null; // å–å¾—ã—ãŸGeoJSONãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    let isFavoriteMode = false; // ãŠæ°—ã«å…¥ã‚Šè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
    let currentPopupCode = null; // å†æç”»æ™‚ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒã™ã‚‹ãŸã‚ã®å¤‰æ•°

    // --- å‡¡ä¾‹ã®ç”Ÿæˆ ---
    const legendContainer = document.getElementById('legend');
    SNOW_COLORS.forEach(item => {
      // 0cmã‚‚è¡¨ç¤ºã™ã‚‹
      const div = document.createElement('div');
      div.className = 'legend-item';
      // 0cmã®å ´åˆã¯æ ç·šã‚’ã¤ã‘ã‚‹ (min === 0 ã§åˆ¤å®š)
      const borderStyle = item.min === 0 ? 'border: 1px solid #999;' : '';
      div.innerHTML = `<div class="legend-color" style="background:${item.color}; ${borderStyle}"></div><span>${item.label}</span>`;
      legendContainer.appendChild(div);
    });

    // --- UI ãƒ‘ãƒãƒ«åˆ¶å¾¡ ---
    function togglePanel() {
      const body = document.getElementById('panel-body');
      const icon = document.getElementById('panel-toggle-icon');
      const panel = document.getElementById('info-panel');

      if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.style.transform = 'rotate(0deg)'; // å…ƒã«æˆ»ã™
        panel.style.height = 'auto'; 
      } else {
        body.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)'; // æ¨ªå‘ãã«ã™ã‚‹
        panel.style.height = 'auto';
      }
    }

    // --- LocalStorage / ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ ---
    function getFavorites() {
      try {
        // æ–‡å­—åˆ—å‹ã¨ã—ã¦å–å¾—ãƒ»ä¿å­˜ã‚’çµ±ä¸€ã™ã‚‹
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]').map(String);
      } catch {
        return [];
      }
    }

    function isFavorite(code) {
      return getFavorites().includes(String(code));
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹ (ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰å‘¼ã¶ãŸã‚)
    window.toggleFavorite = function (code) {
      const strCode = String(code); // å‹ã‚’æ–‡å­—åˆ—ã«çµ±ä¸€
      let favs = getFavorites();

      let isFavNow = false;

      if (favs.includes(strCode)) {
        favs = favs.filter(c => c !== strCode);
        isFavNow = false;
      } else {
        favs.push(strCode);
        isFavNow = true;
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(favs));

      // å†æç”»ã‚’è¡Œã† (ã‚¹ã‚¿ã‚¤ãƒ«ã®å³æ™‚åæ˜ ã®ãŸã‚)
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã¦ã—ã¾ã‚ãªã„ã‚ˆã†ã€currentPopupCode ã‚’ã‚»ãƒƒãƒˆã—ã¦ renderMap ã§å¾©å…ƒã™ã‚‹
      currentPopupCode = strCode;
      renderMap();
    };

    // --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ---
    window.switchMode = function (toFavoriteMode) {
      isFavoriteMode = toFavoriteMode;

      const tabAll = document.getElementById('tab-all');
      const tabFav = document.getElementById('tab-fav');

      const activeClass = "flex-1 py-2 text-sm font-bold text-center cursor-pointer transition-colors border-b-2 border-blue-600 text-blue-600";
      const inactiveClass = "flex-1 py-2 text-sm font-bold text-center cursor-pointer transition-colors border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50";

      if (isFavoriteMode) {
        tabAll.className = inactiveClass;
        tabFav.className = activeClass;
      } else {
        tabAll.className = activeClass;
        tabFav.className = inactiveClass;
      }

      renderMap();
    };

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---

    // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸåŠå¾„è¨ˆç®—
    function calcRadius(zoom, snowDepth) {
      // 0cmåœ°ç‚¹ã¯è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚æœ€å°åŠå¾„ã‚’ç¢ºä¿ (ä¿®æ­£: ã‚µã‚¤ã‚ºã‚¢ãƒƒãƒ—)
      if (snowDepth <= 0) return zoom < 7 ? 3 : 5;

      // åŸºç¤ã‚µã‚¤ã‚º: ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„ã»ã©å¤§ãã
      let baseSize = (zoom - 4) * 1.2;
      if (baseSize < 2) baseSize = 2;

      // ç©é›ªé‡è£œæ­£: 
      let depthFactor = Math.sqrt(snowDepth) * 0.4;

      let radius = baseSize + depthFactor;
      if (radius > 25) radius = 25; // æœ€å¤§ã‚µã‚¤ã‚ºåˆ¶é™

      return radius;
    }

    function getSnowDepth(props) {
      let val = undefined;
      if (props.val !== undefined) val = props.val;
      else if (props.snow !== undefined) val = props.snow;
      else if (props.snowd !== undefined) val = props.snowd;

      if (val === undefined) {
        for (const key in props) {
          if (typeof props[key] === 'number') {
            val = props[key];
            break;
          }
        }
      }
      if (val === undefined || val === null) return null;
      const num = parseInt(val, 10);
      return isNaN(num) ? null : num;
    }

    // UTCæ–‡å­—åˆ—(YYYYMMDDHHmm)ã‚’JSTæ–‡å­—åˆ—(YYYY/MM/DD HH:mm)ã«å¤‰æ›
    function formatUtcToJst(dateStr) {
      if (!dateStr || dateStr.length < 12) return "--/-- --:--";
      const year = parseInt(dateStr.substring(0, 4), 10);
      const month = parseInt(dateStr.substring(4, 6), 10) - 1;
      const day = parseInt(dateStr.substring(6, 8), 10);
      const hour = parseInt(dateStr.substring(8, 10), 10);
      const min = parseInt(dateStr.substring(10, 12), 10);

      const utcDate = new Date(Date.UTC(year, month, day, hour, min));

      const JST_OFFSET = 9 * 60 * 60 * 1000;
      const jstDate = new Date(utcDate.getTime() + JST_OFFSET);

      const y = jstDate.getUTCFullYear();
      const m = String(jstDate.getUTCMonth() + 1).padStart(2, '0');
      const d = String(jstDate.getUTCDate()).padStart(2, '0');
      const h = String(jstDate.getUTCHours()).padStart(2, '0');
      const mi = String(jstDate.getUTCMinutes()).padStart(2, '0');

      return `${y}/${m}/${d} ${h}:${mi}`;
    }

    // --- ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ ---

    async function fetchWithProxy(url) {
      try {
        const targetUrl = PROXY_URL + encodeURIComponent(url);
        const response = await fetch(targetUrl);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
      } catch (e) {
        console.error("Fetch failed (Proxy):", e);
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (e2) {
          throw new Error(`ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        }
      }
    }

    async function getLatestSnowTimeData() {
      const url = `${JMA_TILE_BASE}/targetTimes.json`;
      try {
        const data = await fetchWithProxy(url);
        if (!Array.isArray(data)) throw new Error("targetTimes is not an array");

        const latestValid = data.find(item =>
          item.elements && item.elements.includes("amds_snowd")
        );

        if (latestValid) return latestValid;
        throw new Error("Valid snow data (amds_snowd) not found in targetTimes");
      } catch (e) {
        console.error(e);
        throw new Error("æœ€æ–°æ™‚åˆ»æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }

    map.on('zoomend', function () {
      if (!geoJsonLayer) return;
      const currentZoom = map.getZoom();

      geoJsonLayer.eachLayer(function (layer) {
        if (layer.feature && layer.feature.properties) {
          const snowDepth = getSnowDepth(layer.feature.properties) || 0;
          layer.setRadius(calcRadius(currentZoom, snowDepth));
        }
      });
    });

    // ãƒãƒƒãƒ—æç”»é–¢æ•°
    function renderMap() {
      if (!currentGeoData) return;

      if (geoJsonLayer) {
        map.removeLayer(geoJsonLayer);
      }

      let count = 0;
      const favs = getFavorites();

      geoJsonLayer = L.geoJSON(currentGeoData, {
        filter: function (feature) {
          const props = feature.properties || {};
          const snowDepth = getSnowDepth(props);

          if (snowDepth === null || snowDepth === 32767) return false;

          if (isFavoriteMode) {
            return favs.includes(String(props.code));
          }

          return true;
        },
        pointToLayer: function (feature, latlng) {
          const snowDepth = getSnowDepth(feature.properties || {});

          let color = '#ccc';
          let opacity = 0.5;
          let borderColor = '#fff';

          if (snowDepth > 0) {
            opacity = 0.9;
            for (const c of SNOW_COLORS) {
              if (snowDepth >= c.min) {
                color = c.color;
                break;
              }
            }
          } else {
            color = '#cccccc'; // ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´
            borderColor = '#666'; // å°‘ã—æ¿ƒã„æ ç·š
            opacity = 1.0;
          }

          if (snowDepth > 0) count++;

          const radius = calcRadius(map.getZoom(), snowDepth);

          return L.circleMarker(latlng, {
            radius: radius,
            fillColor: color,
            color: borderColor,
            weight: 1,
            opacity: opacity,
            fillOpacity: opacity
          });
        },
        onEachFeature: function (feature, layer) {
          const props = feature.properties || {};
          let snowDepth = getSnowDepth(props);
          if (snowDepth === null) snowDepth = "ä¸æ˜";

          const nameJP = props.nameJP || props.kjName;
          const nameKana = props.nameKana || props.knName;
          let displayName = "";
          let subName = "";

          if (nameJP && nameKana) {
            displayName = nameJP;
            subName = nameKana;
          } else {
            displayName = nameJP || props.name || nameKana || props.code || "åœ°ç‚¹";
          }
          if (!displayName || displayName === "åœ°ç‚¹") {
            displayName = `åœ°ç‚¹`;
          }

          const code = props.code;
          let graphLinkHtml = "";
          let favBtnHtml = "";

          if (code) {
            const jmaGraphUrl = `https://www.jma.go.jp/bosai/amedas/#amdno=${code}&format=graph&elem=snow`;
            // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ (ç™½èƒŒæ™¯ãƒ»é’æ–‡å­—)
            graphLinkHtml = `
              <a
                href="${jmaGraphUrl}" target="_blank" rel="noopener noreferrer" 
                class="flex-1 bg-white hover:bg-blue-50 text-blue-600 border border-blue-600 text-sm font-bold py-2 px-3 rounded text-center transition no-underline flex items-center justify-center" style="color: #2563eb !important; text-decoration: none !important;">

                ğŸ“Š æ¨ç§»ã‚°ãƒ©ãƒ•
              </a>
            `;

            // ã‚·ãƒ³ãƒ—ãƒ«ãªãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³
            // å‹ã‚’Stringã«çµ±ä¸€ã—ã¦ãƒã‚§ãƒƒã‚¯
            const isFav = isFavorite(String(code));
            const btnText = isFav ? 'â˜… è§£é™¤' : 'â˜† ãŠæ°—ã«å…¥ã‚Š';
            const btnClass = isFav
              ? "flex-1 bg-yellow-50 text-yellow-700 border border-yellow-300 text-sm font-bold py-2 px-3 rounded cursor-pointer hover:bg-yellow-100 transition flex items-center justify-center"
              : "flex-1 bg-white text-gray-600 border border-gray-300 text-sm font-bold py-2 px-3 rounded cursor-pointer hover:bg-gray-50 transition flex items-center justify-center";

            // onclickã§å†æç”»ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
            favBtnHtml = `
              <button onclick="toggleFavorite('${code}')" class="${btnClass}">
                  ${btnText}
              </button>
            `;

            // ãŠæ°—ã«å…¥ã‚Šåœ°ç‚¹ã®å ´åˆã€ç©é›ªé‡ã‚’å¸¸æ™‚è¡¨ç¤ºã™ã‚‹Tooltipã‚’è¨­å®š (å¼·èª¿è¡¨ç¤º)
            if (isFav && snowDepth !== null) {
              // è‰²ã®æ±ºå®š (å‡¡ä¾‹ã¨åŒæœŸ)
              let bgColor = '#cccccc';
              let textColor = '#000000';

              if (snowDepth > 0) {
                for (const c of SNOW_COLORS) {
                  if (snowDepth >= c.min) {
                    bgColor = c.color;
                    break;
                  }
                }
              }

              // è¦–èªæ€§ã®ãŸã‚ã«æ¿ƒã„èƒŒæ™¯è‰²ã®å ´åˆã¯ç™½æ–‡å­—ã«ã™ã‚‹
              const darkColors = ['#e600ab', '#ff2800', '#0041ff', '#218cff'];
              if (darkColors.includes(bgColor)) {
                textColor = '#ffffff';
              }

              // ã‚¹ã‚¿ã‚¤ãƒ«ä»˜ãHTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
              const tooltipHtml = `
                <div style="
                  background-color: ${bgColor};
                  color: ${textColor};
                  padding: 2px 6px;
                  border-radius: 4px;
                  font-weight: bold;
                  font-size: 12px;
                  border: 1px solid rgba(0,0,0,0.15);
                  box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
                  white-space: nowrap;
                  text-align: center;
                ">
                  ${snowDepth}cm
                </div>
              `;

              layer.bindTooltip(tooltipHtml, {
                permanent: true,
                direction: 'right',
                offset: [8, 0],
                className: 'fav-label', // CSSã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                opacity: 1
              });
            }
          }

          // ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã—ãŸãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ‡ã‚¶ã‚¤ãƒ³
          // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’ flex (row) gap-2 ã«å¤‰æ›´ã—ã¦æ¨ªä¸¦ã³ã«ã™ã‚‹
          layer.bindPopup(`
            <div class="font-sans">
                <div class="font-bold text-lg mb-1">${displayName}</div>
                ${subName ? `<div class="text-xs text-gray-600 mb-1">${subName}</div>` : ''}
                <hr class="my-2 border-gray-300">
                <div class="mb-2">
                    <span class="text-sm text-gray-600">ç©é›ªæ·±:</span>
                    <span class="font-bold text-xl ml-1">${snowDepth}</span>
                    <span class="text-sm">cm</span>
                </div>
                <div class="flex gap-2 mt-2">
                    ${graphLinkHtml}
                    ${favBtnHtml}
                </div>
            </div>
          `, { minWidth: 240 }); // æ¨ªä¸¦ã³ã«ã™ã‚‹ã®ã§å°‘ã—å¹…ã‚’ç¢ºä¿
        }
      }).addTo(map);

      // ãƒªã‚¹ãƒˆã®æ›´æ–°
      updateRankingList();

      // å†æç”»å¾Œã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒã™ã‚‹å‡¦ç†
      if (currentPopupCode) {
        geoJsonLayer.eachLayer(function (layer) {
          const props = layer.feature.properties || {};
          if (String(props.code) === String(currentPopupCode)) {
            layer.openPopup();
          }
        });
        currentPopupCode = null; // ãƒªã‚»ãƒƒãƒˆ
      }
    }

    // --- ãƒªã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ ---
    function updateRankingList() {
      const container = document.getElementById('ranking-container');
      if (!currentGeoData || !currentGeoData.features) return;

      // ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã¨æ•´å½¢
      let items = currentGeoData.features.map(f => {
        const props = f.properties;
        const snowDepth = getSnowDepth(props);

        // åœ°ç‚¹åè§£æ±º
        const nameJP = props.nameJP || props.kjName;
        const nameKana = props.nameKana || props.knName;
        let displayName = "";
        if (nameJP && nameKana) displayName = nameJP;
        else displayName = nameJP || props.name || nameKana || props.code || "åœ°ç‚¹";

        return {
          code: String(props.code),
          name: displayName,
          snowDepth: snowDepth,
          lat: f.geometry.coordinates[1],
          lon: f.geometry.coordinates[0]
        };
      }).filter(item => item.snowDepth !== null && item.snowDepth !== 32767);

      // é™é †ã‚½ãƒ¼ãƒˆ
      items.sort((a, b) => b.snowDepth - a.snowDepth);

      // ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿
      let displayItems = [];
      let title = "";

      if (isFavoriteMode) {
        const favs = getFavorites();
        displayItems = items.filter(item => favs.includes(item.code));
        title = `â­ï¸ ãŠæ°—ã«å…¥ã‚Šåœ°ç‚¹`;
        if (displayItems.length === 0) {
          container.innerHTML = `
            <h3 class="text-sm font-bold text-gray-700 mb-2">${title}</h3>
            <div class="text-sm text-gray-500 text-center py-2 bg-gray-50 rounded">ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
          `;

          return;
        }
      } else {
        displayItems = items.slice(0, 20);
        title = "ğŸ“Š ç©é›ªé‡ãƒ©ãƒ³ã‚­ãƒ³ã‚° (Top20)";
      }

      // HTMLç”Ÿæˆ
      let html = `
        <h3 class="text-sm font-bold text-gray-700 mb-2">${title}</h3>
        <ul class="text-sm space-y-1 max-h-40 overflow-y-auto pr-1">
      `;

      displayItems.forEach((item, index) => {
        const rank = `<span class="inline-block w-5 text-center font-bold text-gray-500 mr-1">${index + 1}.</span>`;

        html += `
          <li class="flex justify-between items-center p-2 hover:bg-blue-50 rounded border border-transparent hover:border-blue-100 cursor-pointer transition-colors" onclick="flyToPoint(${item.lat}, ${item.lon}, '${item.code}')">
              <div class="truncate flex-1 flex items-center">
                  ${rank}
                  <span class="font-medium text-gray-800 truncate">${item.name}</span>
              </div>
              <div class="font-bold text-blue-800 whitespace-nowrap ml-2">
                  ${item.snowDepth} <span class="text-xs text-gray-600">cm</span>
              </div>
          </li>
        `;
      });

      html += '</ul>';

      container.innerHTML = html;
    }

    // åœ°ç‚¹ã¸ç§»å‹•ã—ã¦ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
    window.flyToPoint = function (lat, lon, code) {
      map.flyTo([lat, lon], 12, { duration: 1.5 });
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ããŸã‚ã«å°‘ã—å¾…ã¤ (ç§»å‹•å®Œäº†å¾Œ)
      setTimeout(() => {
        if (geoJsonLayer) {
          geoJsonLayer.eachLayer(layer => {
            const props = layer.feature.properties || {};
            if (String(props.code) === String(code)) {
              layer.openPopup();
            }
          });
        }
      }, 1600);
    };

    window.loadData = async function () {
      const timeDiv = document.getElementById('data-time');

      try {
        const timeData = await getLatestSnowTimeData();

        const basetime = timeData.basetime;
        const validtime = timeData.validtime;

        if (timeData.obstimeJST) {
          timeDiv.textContent = timeData.obstimeJST;
        } else {
          timeDiv.textContent = formatUtcToJst(basetime);
        }

        console.log(`Target Time (UTC): base=${basetime}, valid=${validtime}`);

        const geoJsonUrl = `${JMA_TILE_BASE}/${basetime}/none/${validtime}/surf/amds_snowd/data.geojson?id=amds_snowd`;
        currentGeoData = await fetchWithProxy(geoJsonUrl);
        renderMap();

      } catch (error) {
        console.error(error);
      }
    }

    window.onload = loadData;
  </script>
</body>

</html>